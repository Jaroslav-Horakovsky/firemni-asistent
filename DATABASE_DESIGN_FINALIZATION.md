# üóÑÔ∏è DATABASE DESIGN FINALIZATION - KRITICK√Å F√ÅZE

## üéØ **√öƒåEL TOHOTO DOKUMENTU**

**P≈òED p≈ôechodem na frontend development MUS√çME:**
1. ‚úÖ Dokonƒçit v≈°echny backend funkcionalitu (zb√Ωvaj√≠c√≠ 15%)
2. üîç Kompletnƒõ p≈ôezkoumat database design
3. üõ†Ô∏è Implementovat zmƒõny pro budouc√≠ flexibilitu  
4. ‚úÖ Otestovat a validovat fin√°ln√≠ strukturu
5. üîí "Zamknout" database sch√©ma pro production

**PROƒå TO DƒöL√ÅME TEƒéKA:**
- Database zmƒõny v produkci = nightmare slo≈æitosti
- Frontend + Mobile + Backend mus√≠ b√Ωt v synchronizaci
- Lep≈°√≠ str√°vit t√Ωden teƒèka ne≈æ mƒõs√≠c v produkci

---

## üìä **SOUƒåASN√ù STAV DATABASE SCHEMAS**

### **USER_DB (‚úÖ Stabiln√≠ - zmƒõny nepravdƒõpodobn√©)**
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    role VARCHAR(50) DEFAULT 'user',
    is_active BOOLEAN DEFAULT true,
    email_verified BOOLEAN DEFAULT false,
    last_login TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### **CUSTOMER_DB (‚ö†Ô∏è Pot≈ôebuje review)**
```sql
CREATE TABLE customers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_name VARCHAR(255) NOT NULL,
    contact_person VARCHAR(255),
    email VARCHAR(255),
    phone VARCHAR(50),
    address_line1 VARCHAR(255),
    address_line2 VARCHAR(255),  
    city VARCHAR(100),
    postal_code VARCHAR(20),
    country VARCHAR(100) DEFAULT 'Czech Republic',
    tax_id VARCHAR(50),
    vat_id VARCHAR(50),
    payment_terms INTEGER DEFAULT 14,
    credit_limit DECIMAL(12,2) DEFAULT 0.00,
    is_active BOOLEAN DEFAULT true,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### **ORDER_DB (üö® Kritick√Ω review - hlavn√≠ business logic)**
```sql
-- Orders table
CREATE TABLE orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_number VARCHAR(50) UNIQUE NOT NULL,
    customer_id UUID NOT NULL REFERENCES customers(id),
    status order_status_enum DEFAULT 'draft',
    subtotal DECIMAL(12,2) NOT NULL DEFAULT 0.00,
    tax_amount DECIMAL(12,2) DEFAULT 0.00,
    shipping_amount DECIMAL(12,2) DEFAULT 0.00,
    discount_amount DECIMAL(12,2) DEFAULT 0.00,
    total_amount DECIMAL(12,2) NOT NULL DEFAULT 0.00,
    currency VARCHAR(3) DEFAULT 'CZK',
    
    -- Addresses
    billing_address_line1 VARCHAR(255),
    billing_address_line2 VARCHAR(255),
    billing_city VARCHAR(100),
    billing_postal_code VARCHAR(20),
    billing_country VARCHAR(100),
    
    shipping_address_line1 VARCHAR(255),
    shipping_address_line2 VARCHAR(255),
    shipping_city VARCHAR(100),
    shipping_postal_code VARCHAR(20),
    shipping_country VARCHAR(100),
    
    -- Metadata
    notes TEXT,
    internal_notes TEXT,
    payment_method VARCHAR(50),
    payment_due_date DATE,
    
    -- Audit
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- Constraints
    CONSTRAINT positive_subtotal CHECK (subtotal >= 0),
    CONSTRAINT positive_total CHECK (total_amount >= 0),
    CONSTRAINT valid_currency CHECK (currency IN ('CZK', 'EUR', 'USD'))
);

-- Order items
CREATE TABLE order_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
    product_name VARCHAR(255) NOT NULL,
    product_description TEXT,
    product_sku VARCHAR(100),
    quantity INTEGER NOT NULL,
    unit_price DECIMAL(12,2) NOT NULL,
    total_price DECIMAL(12,2) NOT NULL,
    tax_rate DECIMAL(5,2) DEFAULT 0.00,
    
    -- Product metadata (future inventory integration)
    product_category VARCHAR(100),
    product_unit VARCHAR(20) DEFAULT 'pcs',
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- Constraints  
    CONSTRAINT positive_quantity CHECK (quantity > 0),
    CONSTRAINT positive_unit_price CHECK (unit_price >= 0),
    CONSTRAINT positive_total_price CHECK (total_price >= 0)
);

-- Order status history
CREATE TABLE order_status_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
    old_status order_status_enum,
    new_status order_status_enum NOT NULL,
    changed_by UUID REFERENCES users(id),
    change_reason TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## üîç **BUSINESS REQUIREMENTS REVIEW**

### **KL√çƒåOV√â OT√ÅZKY PRO DESIGN:**

#### **1. ORDERS & BUSINESS LOGIC:**
- [ ] **Podporujeme jen CZK nebo i EUR/USD?** ‚Üí Ovlivn√≠ currency logic
- [ ] **Pot≈ôebujeme slevy na √∫rovni objedn√°vky nebo itemu?** ‚Üí Discount structure
- [ ] **Jak slo≈æit√© budou danƒõ?** ‚Üí Tax calculation complexity
- [ ] **Budou recurring objedn√°vky?** ‚Üí Subscription model
- [ ] **Pot≈ôebujeme approval workflow?** ‚Üí Order approval process

#### **2. CUSTOMERS & CRM:**
- [ ] **Budou B2B i B2C z√°kazn√≠ci?** ‚Üí Customer type differentiation
- [ ] **Pot≈ôebujeme customer hierarchy?** ‚Üí Parent/child companies
- [ ] **Jak√© kontakty per customer?** ‚Üí Multiple contacts per company
- [ ] **Customer segments/categories?** ‚Üí Marketing & pricing tiers
- [ ] **Customer history tracking?** ‚Üí Interaction logs

#### **3. PRODUCTS & INVENTORY:**
- [ ] **Jak komplexn√≠ bude product catalog?** ‚Üí Product variations, bundles
- [ ] **Sledov√°n√≠ inventory?** ‚Üí Stock levels, reservations
- [ ] **Product categories/hierarchies?** ‚Üí Classification system
- [ ] **Digital vs physical products?** ‚Üí Fulfillment differences
- [ ] **Product pricing tiers?** ‚Üí Customer-specific pricing

#### **4. BUSINESS WORKFLOWS:**
- [ ] **Invoice generation process?** ‚Üí Billing integration
- [ ] **Payment tracking?** ‚Üí Payment status, partial payments
- [ ] **Shipping integration?** ‚Üí Tracking numbers, carriers
- [ ] **Returns/refunds process?** ‚Üí Reverse logistics
- [ ] **Reporting requirements?** ‚Üí Analytics & KPIs

---

## üõ†Ô∏è **FLEXIBILITA & FUTURE-PROOFING STRATEGIES**

### **1. METADATA COLUMNS (Immediate Implementation):**
```sql
-- P≈ôidat do v≈°ech hlavn√≠ch tabulek:
ALTER TABLE customers ADD COLUMN metadata JSONB DEFAULT '{}';
ALTER TABLE orders ADD COLUMN metadata JSONB DEFAULT '{}';
ALTER TABLE order_items ADD COLUMN metadata JSONB DEFAULT '{}';
ALTER TABLE users ADD COLUMN metadata JSONB DEFAULT '{}';

-- Indexy pro rychl√© JSONB queries:
CREATE INDEX idx_customers_metadata ON customers USING GIN (metadata);
CREATE INDEX idx_orders_metadata ON orders USING GIN (metadata);
```

**V√Ωhoda:** M≈Ø≈æeme p≈ôid√°vat nov√° pole bez database migration!
```javascript
// M√≠sto ALTER TABLE:
customer.metadata = { priority: 'high', segment: 'enterprise', tags: ['vip'] }
```

### **2. AUDIT TRAIL SYSTEM:**
```sql
-- Universal audit table pro v≈°echny zmƒõny:
CREATE TABLE audit_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    table_name VARCHAR(100) NOT NULL,
    record_id UUID NOT NULL,
    action VARCHAR(20) NOT NULL, -- INSERT, UPDATE, DELETE
    old_values JSONB,
    new_values JSONB,
    changed_by UUID REFERENCES users(id),
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- Pro rychl√© vyhled√°v√°n√≠:
    INDEX idx_audit_table_record (table_name, record_id),
    INDEX idx_audit_changed_by (changed_by),
    INDEX idx_audit_changed_at (changed_at)
);
```

### **3. VERSIONING SYSTEM:**
```sql
-- Pro kritick√© entity (orders, customers):
ALTER TABLE orders ADD COLUMN version INTEGER DEFAULT 1;
ALTER TABLE customers ADD COLUMN version INTEGER DEFAULT 1;

-- Version history table:
CREATE TABLE entity_versions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    entity_type VARCHAR(50) NOT NULL,
    entity_id UUID NOT NULL,
    version INTEGER NOT NULL,
    data JSONB NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(entity_type, entity_id, version)
);
```

### **4. CONFIGURATION SYSTEM:**
```sql
-- Pro business rules kter√© se m≈Ø≈æou mƒõnit:
CREATE TABLE system_config (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value JSONB NOT NULL,
    description TEXT,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- P≈ô√≠klady:
INSERT INTO system_config (config_key, config_value, description) VALUES
('tax_rates', '{"standard": 21, "reduced": 15}', 'DPH sazby'),
('currencies', '["CZK", "EUR", "USD"]', 'Podporovan√© mƒõny'),
('order_statuses', '["draft", "pending", "confirmed", "processing", "shipped", "delivered", "cancelled"]', 'Stavy objedn√°vek'),
('payment_methods', '["bank_transfer", "card", "cash", "invoice"]', 'Zp≈Øsoby platby');
```

---

## üìã **AKƒåN√ç PL√ÅN - DATABASE FINALIZATION**

### **F√ÅZE 1: DOKONƒåEN√ç SOUƒåASN√â FUNKCIONALITY (1 t√Ωden)**
- [ ] **Opravit order creation bug** (Relace 13 priorita)
- [ ] **Kompletn√≠ backend testing** v≈°ech CRUD operac√≠
- [ ] **Performance testing** datab√°zov√Ωch operac√≠
- [ ] **Security audit** v≈°ech API endpoints

### **F√ÅZE 2: BUSINESS REQUIREMENTS GATHERING (2-3 dny)**
- [ ] **Proj√≠t business ot√°zky** v√Ω≈°e s v√°mi (majitelem)
- [ ] **Definovat missing requirements** pro production
- [ ] **Prioritizovat features** podle d≈Øle≈æitosti
- [ ] **Dokumentovat business rules** pro implementaci

### **F√ÅZE 3: DATABASE ENHANCEMENT (3-4 dny)**
- [ ] **Implementovat metadata columns** pro flexibilitu
- [ ] **P≈ôidat audit trail system** pro tracking zmƒõn
- [ ] **Setup configuration system** pro business rules
- [ ] **Enhance indexy** pro performance
- [ ] **Add foreign key constraints** kde chyb√≠

### **F√ÅZE 4: MIGRATION SYSTEM SETUP (2 dny)**
- [ ] **Install migration tools** (Knex.js nebo Sequelize)
- [ ] **Create baseline migrations** pro souƒçasn√Ω stav
- [ ] **Setup migration scripts** pro development/production
- [ ] **Document migration process** pro t√Ωm

### **F√ÅZE 5: FINAL VALIDATION (2 dny)**
- [ ] **Load testing** s re√°ln√Ωmi objemy dat
- [ ] **Business logic validation** se v≈°emi workflows
- [ ] **Backup/restore testing** pro disaster recovery
- [ ] **Documentation update** pro production readiness

---

## üîí **SCHEMA FREEZE CRITERIA**

**DATABASE SCH√âMA SM√çME "ZAMKNOUT" TEPRVE KDY≈Ω:**

### ‚úÖ **TECHNICAL CRITERIA:**
- [ ] V≈°echny backend API endpoints funguj√≠ 100%
- [ ] Performance je pod 200ms pro 95% queries
- [ ] V≈°echny foreign key constraints spr√°vnƒõ nastaven√©
- [ ] Indexy pokr√Ωvaj√≠ v≈°echny ƒçasto pou≈æ√≠van√© queries
- [ ] Backup/restore process otestov√°n

### ‚úÖ **BUSINESS CRITERIA:**  
- [ ] V≈°echny core business workflows implementovan√©
- [ ] Tax calculation logic odpov√≠d√° po≈æadavk≈Øm
- [ ] Order status transitions pokr√Ωvaj√≠ v≈°echny sc√©n√°≈ôe
- [ ] Customer management m√° v≈°echny pot≈ôebn√© fieldy
- [ ] Reporting requirements jsou splnƒõn√©

### ‚úÖ **FUTURE-PROOFING CRITERIA:**
- [ ] Metadata columns pro flexibilitu p≈ôidan√©
- [ ] Audit trail system implementovan√Ω
- [ ] Configuration system pro business rules
- [ ] Migration system p≈ôipraven√Ω
- [ ] Versioning strategy definovan√°

---

## üö® **WARNING SIGNS - NESCHV√ÅLIT FREEZE POKUD:**

- ‚ùå Jak√Ωkoliv core workflow nefunguje
- ‚ùå Performance probl√©my (>500ms response times)
- ‚ùå Chyb√≠ kritick√© business fieldy
- ‚ùå Database design neodpov√≠d√° business process≈Øm
- ‚ùå ≈Ω√°dn√Ω migration strategy
- ‚ùå Nejasn√© business requirements

---

## üéØ **SUCCESS METRICS PRO SCHEMA FREEZE**

```
üìä MUS√çME DOS√ÅHNOUT:
‚îú‚îÄ‚îÄ üöÄ API Response Times: <200ms (95th percentile)
‚îú‚îÄ‚îÄ üß™ Test Coverage: >90% pro business logic
‚îú‚îÄ‚îÄ üîç Business Validation: 100% core workflows
‚îú‚îÄ‚îÄ üìã Documentation: Complete API + database docs
‚îú‚îÄ‚îÄ üõ°Ô∏è Security: All endpoints properly secured
‚îú‚îÄ‚îÄ üîÑ Migration: Automated migration system ready
‚îî‚îÄ‚îÄ üíæ Backup: Disaster recovery plan tested
```

---

## üìù **NEXT STEPS - IMMEDIATE ACTIONS**

### **1. RELACE 13 (Immediate - tento t√Ωden):**
- Opravit order creation bug
- Complete backend functionality testing

### **2. BUSINESS REQUIREMENTS SESSION (p≈ô√≠≈°t√≠ t√Ωden):**
- Proj√≠t v≈°echny business ot√°zky v tomto dokumentu
- Definovat missing requirements
- Prioritizovat features pro MVP

### **3. DATABASE ENHANCEMENT (t√Ωden pot√©):**
- Implementovat flexibilitu features
- Setup migration system  
- Final performance optimization

### **4. SCHEMA FREEZE DECISION (3 t√Ωdny od teƒè):**
- GO/NO-GO rozhodnut√≠ pro frontend development
- Kompletn√≠ business & technical validation
- Production readiness assessment

---

**üéØ Z√ÅVƒöR: Investice 2-3 t√Ωdn≈Ø teƒèka = u≈°et≈ôen√≠ 2-3 mƒõs√≠c≈Ø probl√©m≈Ø v produkci!**

**Toto je jedna z nejd≈Øle≈æitƒõj≈°√≠ch f√°z√≠ cel√©ho projektu. Lep≈°√≠ b√Ωt opatrn√Ω teƒèka ne≈æ ≈ôe≈°it probl√©my pozdƒõji.** üõ°Ô∏è